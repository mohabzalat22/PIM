generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductType {
  SIMPLE
  CONFIGURABLE
  BUNDLE
  VIRTUAL
  DOWNLOADABLE
}

enum ProductStatus {
  DRAFT
  ENRICHMENT
  VALIDATION
  APPROVAL
  PUBLISHING
}

model Product {
  id        Int         @id @default(autoincrement())
  sku       String      @unique
  type      ProductType @default(SIMPLE)
  status    ProductStatus @default(DRAFT)
  attributeSetId Int?
  assignedTo Int?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  /**
   * Relations
   */
  productAssets          ProductAsset[]
  productCategories      ProductCategory[]
  productAttributeValues ProductAttributeValue[]
  workflowHistory        ProductWorkflowHistory[]
  attributeSet           AttributeSet?        @relation(fields: [attributeSetId], references: [id], onDelete: SetNull)
  assignedUser           User?                @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
}

model ProductWorkflowHistory {
  id          Int           @id @default(autoincrement())
  productId   Int
  fromStatus  ProductStatus?
  toStatus    ProductStatus
  changedById Int?
  notes       String?
  createdAt   DateTime      @default(now())

  /**
   * Relations
   */
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  changedBy   User?    @relation(fields: [changedById], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([createdAt])
}

model Asset {
  id        Int      @id @default(autoincrement())
  filePath  String
  mimeType  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
   * Relations
   */
  productAssets ProductAsset[]
}

model ProductAsset {
  id        Int      @id @default(autoincrement())
  productId Int?
  assetId   Int?
  position  Int?
  type      String // image, video, pdf, manual
  createdAt DateTime @default(now())

  /**
   * Relations
   */
  product Product? @relation(fields: [productId], references: [id])
  asset   Asset?   @relation(fields: [assetId], references: [id])

  @@unique([productId, assetId, type])
}

model Category {
  id        Int      @id @default(autoincrement())
  parentId  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
   * Relations
   */
  parent            Category?             @relation("CategoryToSubcategories", fields: [parentId], references: [id])
  subcategory       Category[]            @relation("CategoryToSubcategories")
  productCategories ProductCategory[]
  translations      CategoryTranslation[]
}

model CategoryTranslation {
  id          Int      @id @default(autoincrement())
  categoryId  Int?
  storeViewId Int?
  name        String?
  slug        String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  /**
   * Relations
   */
  category  Category?  @relation(fields: [categoryId], references: [id])
  storeView StoreView? @relation(fields: [storeViewId], references: [id])

  @@unique([categoryId, storeViewId])
}

model ProductCategory {
  id         Int      @id @default(autoincrement())
  productId  Int?
  categoryId Int?
  createdAt  DateTime @default(now())

  /**
   * Relations
   */
  product  Product? @relation(fields: [productId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])

  @@unique([productId, categoryId])
}

enum AttributeDataType {
  BOOLEAN
  STRING
  INT
  DECIMAL
  TEXT
  JSON
}

enum AttributeInputType {
  TEXT
  SELECT
  MULTISELECT
  DATE
  MEDIA
}

model Attribute {
  id           Int                @id @default(autoincrement())
  code         String             @unique
  label        String?
  dataType     AttributeDataType
  inputType    AttributeInputType
  isRequired   Boolean            @default(false)
  isFilterable Boolean            @default(false)
  isGlobal     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  /**
   * Relations
   */
  productAttributeValues ProductAttributeValue[]
  attributeSetAttributes AttributeSetAttribute[]
  attributeSetGroupAttributes AttributeSetGroupAttribute[]
}

model ProductAttributeValue {
  id           Int      @id @default(autoincrement())
  productId    Int?
  attributeId  Int?
  storeViewId  Int? // NULL = global scope, otherwise per store view
  valueString  String?
  valueInt     Int?
  valueDecimal Decimal?
  valueText    String?
  valueBoolean Boolean?
  valueJson    Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  /**
   * Relations
   */
  product   Product?    @relation(fields: [productId], references: [id])
  attribute Attribute?  @relation(fields: [attributeId], references: [id])
  storeView StoreView? @relation(fields: [storeViewId], references: [id])

}

model StoreView {
  id        Int      @id @default(autoincrement())
  storeId   Int?
  localeId  Int?     @unique
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
   * Relations
   */
  store                  Store?                   @relation(fields: [storeId], references: [id])
  locale                 Locale?                  @relation(fields: [localeId], references: [id], onDelete: SetNull)
  productAttributeValues ProductAttributeValue[]
  categoryTranslations   CategoryTranslation[]
}

model Store {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
   * Relations
   */
  storeViews StoreView[]
}

model Locale {
  id        Int      @id @default(autoincrement())
  storeView StoreView?
  value     String   @unique
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AttributeSet {
  id          Int           @id @default(autoincrement())
  code        String        @unique
  label       String
  productType ProductType?  // optional: restrict to a specific product type
  isDefault   Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  /**
   * Relations
   */
  products        Product[]
  groups          AttributeGroup[]
  setAttributes   AttributeSetAttribute[]
  groupAttributes AttributeSetGroupAttribute[]
}

model AttributeGroup {
  id            Int          @id @default(autoincrement())
  attributeSetId Int
  code          String
  label         String
  sortOrder     Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  /**
   * Relations
   */
  attributeSet AttributeSet  @relation(fields: [attributeSetId], references: [id], onDelete: Cascade)
  groupAttributes AttributeSetGroupAttribute[]

  @@unique([attributeSetId, code])
}

model AttributeSetAttribute {
  id             Int        @id @default(autoincrement())
  attributeSetId Int?
  attributeId    Int
  sortOrder      Int        @default(0)

  /**
   * Relations
   */
  attributeSet AttributeSet? @relation(fields: [attributeSetId], references: [id], onDelete: SetNull)
  attribute    Attribute    @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([attributeSetId, attributeId])
}

model AttributeSetGroupAttribute {
  id                 Int             @id @default(autoincrement())
  attributeGroupId   Int?
  attributeSetId     Int?
  attributeId        Int
  sortOrder          Int             @default(0)

  /**
   * Relations
   */
  attributeGroup AttributeGroup?      @relation(fields: [attributeGroupId], references: [id], onDelete: SetNull)
  attributeSet   AttributeSet?        @relation(fields: [attributeSetId], references: [id], onDelete: SetNull)
  attribute      Attribute            @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([attributeSetId, attributeId])
}

model User {
  id                 Int              @id @default(autoincrement())
  clerkId            String           @unique
  stripeCustomerId   String?          @unique
  name               String   
  email              String           @unique
  subscription       Subscription?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
   * Relations
   */
  workspaceMembers    WorkspaceMember[]
  assignedProducts    Product[]
  workflowHistory     ProductWorkflowHistory[]
  ownedWorkspaces           Workspace[] @relation("OwnerWorkspaces")
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELED
  PAST_DUE
}

model Subscription {
  id                   Int                @id @default(autoincrement())
  userId               Int                @unique
  plan                 String
  status               SubscriptionStatus @default(INACTIVE)
  stripeSubscriptionId String?            @unique
  startDate            DateTime?
  endDate              DateTime?
  createdAt DateTime                      @default(now())
  updatedAt DateTime                      @updatedAt

  /**
   * Relations
   */
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum MemberRole {
  ADMIN
  MEMBER
}

model Workspace {
  id Int @id @default(autoincrement())
  name String 
  ownerId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
  relations
  */

  owner User @relation("OwnerWorkspaces", fields: [ownerId], references: [id])
  members WorkspaceMember[]
  invites WorkspaceInvite[]
}
model WorkspaceMember {
  id        Int      @id @default(autoincrement())
  workspaceId    Int
  userId    Int
  role      MemberRole     @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt 

  /**
   * Relations
   */
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}


model WorkspaceInvite{
  id  Int @id @default(autoincrement())
  workspaceId Int
  email String
  token String @unique
  role MemberRole @default(MEMBER)
  expiresAt DateTime 
  usedAt DateTime?
  createdAt DateTime @default(now())

  /**
   relations 
  */

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}
